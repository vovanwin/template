version: '3'

env:
  APP_ENV: local

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
vars:
  DEV_TOOLS: |
    mvdan.cc/gofumpt@v0.8.0
    github.com/daixiang0/gci@v0.13.6
    github.com/mikefarah/yq/v4@v4.45.2
    github.com/bufbuild/buf/cmd/buf@v1.53.0
    google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.6
    google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.5.1
    github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@v2.26.3
    github.com/envoyproxy/protoc-gen-validate@v1.2.1
    github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2@v2.26.3
    github.com/pressly/goose/v3/cmd/goose@latest
    github.com/vovanwin/configgen/cmd/configgen@v0.2.0
    github.com/vovanwin/platform/protogen/cmd/protogen@v0.4.2
    github.com/cludden/protoc-gen-go-temporal/cmd/protoc-gen-go_temporal@v1.22.0
    github.com/a-h/templ/cmd/templ@latest
    github.com/dmarkham/enumer@latest

  DOCKER_COMPOSE_PATHS: |
    -f ./deployments/local/docker-compose.yml
    -f ./deployments/local/docker-compose.temporal.yml
    -f ./deployments/local/docker-compose.centrifugo.yml
#    -f ./deployments/local/docker-compose.metrics.yml
#    -f ./deployments/local/docker-compose.etcd.yml
  #    -f ./deployments/local/docker-compose.jasper.yml

  DOCKER_COMPOSE_CMD: docker-compose  {{range $line := .DOCKER_COMPOSE_PATHS | splitLines -}}
    {{$line}}
    {{end}}

  METRICS_COMPOSE_CMD: >-
    docker-compose
    -f ./deployments/local/docker-compose.metrics.yml

  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v2.3.0'

  BIN_DIR: '{{.ROOT_DIR}}/bin'
  GOLANGCI_LINT: '{{.BIN_DIR}}/golangci-lint'
  GCI: '{{.BIN_DIR}}/gci'
  GOFUMPT: '{{.BIN_DIR}}/gofumpt'
  BUF: '{{.BIN_DIR}}/buf'
  PROTOC_GEN_GO: '{{.BIN_DIR}}/protoc-gen-go'
  PROTOC_GEN_GO_GRPC: '{{.BIN_DIR}}/protoc-gen-go-grpc'
  PROTOC_GEN_GRPC_GATEWAY: '{{.BIN_DIR}}/protoc-gen-grpc-gateway'
  PROTOC_GEN_VALIDATE: '{{.BIN_DIR}}/protoc-gen-validate'
  PROTOC_GEN_OPENAPIV2: '{{.BIN_DIR}}/protoc-gen-openapiv2'
  PROTOC_GEN_GO_TEMPORAL: '{{.BIN_DIR}}/protoc-gen-go_temporal'
  GRPCURL: '{{.BIN_DIR}}/grpcurl'
  MOCKERY: "{{.BIN_DIR}}/mockery"
  GOOSE: "{{.BIN_DIR}}/goose"
  CONFIGGEN: "{{.BIN_DIR}}/configgen"
  PROTOGEN: "{{.BIN_DIR}}/protogen"
  TEMPL: "{{.BIN_DIR}}/templ"
  ENUMER: "{{.BIN_DIR}}/enumer"

  SERVICES: app

  # Database configuration for migrations
  DB_HOST: '{{.APP_HOST_PG | default "localhost"}}'
  DB_PORT: '{{.APP_PORT_PG | default "5432"}}'
  DB_USER: '{{.APP_USER_PG | default "postgres"}}'
  DB_PASSWORD: '{{.APP_PASSWORD_PG | default "postgres"}}'
  DB_NAME: '{{.APP_DBNAME_PG | default "template"}}'
  DB_SCHEMA: '{{.APP_SCHEME_PG | default "public"}}'
  DB_DSN: 'postgres://{{.DB_USER}}:{{.DB_PASSWORD}}@{{.DB_HOST}}:{{.DB_PORT}}/{{.DB_NAME}}?sslmode=disable&search_path={{.DB_SCHEMA}}'

  # Test database configuration
  TEST_DB_NAME: '{{.DB_NAME}}_test'
  TEST_DB_DSN: 'postgres://{{.DB_USER}}:{{.DB_PASSWORD}}@{{.DB_HOST}}:{{.DB_PORT}}/{{.TEST_DB_NAME}}?sslmode=disable&search_path={{.DB_SCHEMA}}'

  MIGRATIONS_DIR: './migrations'

  CONFIG_CONFIGS: ./config
  CONFIG_OUTPUT: ./config

tasks:

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç gofumpt + gci"
    deps: [ install ]
    cmds:
      - |
        echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ gofumpt ..."
        find cmd config internal pkg -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GOFUMPT}} -extra -w {} +
      - |
        echo "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ gci ..."
        find cmd config internal pkg -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GCI}} write -s standard -s default -s "prefix(github.com/vovanwin/template/)" {} +


  lint:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç golangci-lint"
    deps: [ install ]
    cmds:
      - '{{.GOLANGCI_LINT}} run ./... --config=.golangci.yml'


  deps:update:
    desc: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    cmds:
      - go mod tidy


  proto:lint:
    deps: [ install ]
    desc: –ü—Ä–æ–≤–µ—Ä–∫–∞ .proto-—Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∏–ª—é
    dir: api
    cmds:
      - '{{.BUF}} lint'

  proto:gen:
    cmds:
      - task: proto-grpc:gen
      - task: proto-temporal:gen

  proto-grpc:gen:
    deps: []
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ .proto
    dir: api
    cmds:
      - '{{.BUF}} mod update'
      - 'PATH={{.BIN_DIR}}:$PATH {{.BUF}} generate'

  proto-temporal:gen:
    deps: [ ]
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ .proto
    dir: api-workflow
    cmds:
      - '{{.BUF}} mod update'
      - 'PATH={{.BIN_DIR}}:$PATH {{.BUF}} generate'

  # –ö–æ–º–∞–Ω–¥—ã –º–∏–≥—Ä–∞—Ü–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º goose
  migrate:
    desc: "–í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î"
    cmds:
      - '{{.GOOSE}} -dir {{.MIGRATIONS_DIR}} postgres "{{.DB_DSN}}" up'

  migrate:down:
    desc: "–û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω—É –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î"
    cmds:
      - '{{.GOOSE}} -dir {{.MIGRATIONS_DIR}} postgres "{{.DB_DSN}}" down'

  migrate:reset:
    desc: "–û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î"
    cmds:
      - '{{.GOOSE}} -dir {{.MIGRATIONS_DIR}} postgres "{{.DB_DSN}}" reset'

  migrate:create:
    desc: "–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é (task migrate:create -- –∏–º—è_–º–∏–≥—Ä–∞—Ü–∏–∏)"
    cmds:
      - '{{.GOOSE}} -dir {{.MIGRATIONS_DIR}} create {{.CLI_ARGS}} sql'

  # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
  migrate:test:up:
    desc: "–í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î"
    cmds:
      - '{{.GOOSE}} -dir {{.MIGRATIONS_DIR}} postgres "{{.TEST_DB_DSN}}" up'

  migrate:test:reset:
    desc: "–û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î"
    cmds:
      - '{{.GOOSE}} -dir {{.MIGRATIONS_DIR}} postgres "{{.TEST_DB_DSN}}" reset'

  deps:
    dotenv: ['.env']
    desc: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã - –∑–∞–ø—É—Å—Ç–∏—Ç—å
    cmds:
      - "{{.DOCKER_COMPOSE_CMD}} up -d {{.CLI_ARGS}}"

  deps:cmd:
    desc: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã - –≤—ã–ø–æ–ª–Ω–∏—Ç—å cli –∫–æ–º–Ω–¥—É —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
    cmds:
      - "{{.DOCKER_COMPOSE_CMD}} {{.CLI_ARGS}}"   # –ø—Ä–∏–º–µ—Ä: task deps:cmd -- exec postgres bash

  deps:status:
    cmds:
      - "{{.DOCKER_COMPOSE_CMD}} ps -a"

  deps:logs:
    dotenv: ['.env']
    cmds:
      - "{{.DOCKER_COMPOSE_CMD}} logs {{.CLI_ARGS}}"

  deps:stop:
    dotenv: ['.env']
    desc: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
    cmds:
      - "{{.DOCKER_COMPOSE_CMD}} stop"

  deps:reset-psql:
    dotenv: ['.env']
    cmds:
      - task: deps:reset
        vars:
          SERVICES: postgres

  deps:reset:
    dotenv: ['.env']
    cmds:
      - for: { var: SERVICES }
        cmd: "{{.DOCKER_COMPOSE_CMD}} rm -fsv {{.ITEM}}"
      - for: { var: SERVICES }
        cmd: "{{.DOCKER_COMPOSE_CMD}} up -d {{.ITEM}}"

  deps:temporal:
    dotenv: [ '.env' ]
    cmds:
      - temporal server start-dev

  install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
      - for: { var: DEV_TOOLS }
        cmd: GOBIN="{{.BIN_DIR}}"  go install "{{ .ITEM }}"
      - |
        [ -f {{.GOLANGCI_LINT}} ] || {
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh | sh -s {{.GOLANGCI_LINT_VERSION}}
        }

  proto:controllers:
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è stub-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –∏–∑ proto —Ñ–∞–π–ª–æ–≤
    cmds:
      - '{{.PROTOGEN}}'

  generate-config:
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏ feature flags
    cmds:
      - '{{.CONFIGGEN}} --configs={{.CONFIG_CONFIGS}} --output={{.CONFIG_OUTPUT}} --package=config --with-flags'

  validate-config:
    desc: –í–∞–ª–∏–¥–∞—Ü–∏—è TOML —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞
    cmds:
      - '{{.CONFIGGEN}} --validate --configs={{.CONFIG_CONFIGS}}'

  generate:
    desc: –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ (proto, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, –∫–æ–Ω—Ñ–∏–≥–∏, enum, templ)
    cmds:
      - task: proto:gen
      - task: proto:controllers
      - task: generate-config
      - task: enum:gen
      - task: templ:gen

  templ:gen:
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ templ —Ñ–∞–π–ª–æ–≤
    cmds:
      - '{{.TEMPL}} generate'

  enum:gen:
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è enum-–∫–æ–¥–∞ —á–µ—Ä–µ–∑ enumer (go:generate)
    cmds:
      - 'PATH={{.BIN_DIR}}:$PATH go generate ./...'

  run:
    desc: –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    cmds:
      - go build -o {{.BIN_DIR}}/app ./cmd/template
      - '{{.BIN_DIR}}/app --config={{.CONFIG_CONFIGS}}'

  metrics:
    desc: "–ó–∞–ø—É—Å–∫ —Å—Ç–µ–∫–∞ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏ (Prometheus + Grafana + Tempo + OTEL Collector)"
    cmds:
      - "{{.METRICS_COMPOSE_CMD}} up -d {{.CLI_ARGS}}"

  metrics:stop:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–µ–∫–∞ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏"
    cmds:
      - "{{.METRICS_COMPOSE_CMD}} stop"

  metrics:logs:
    desc: "–õ–æ–≥–∏ —Å—Ç–µ–∫–∞ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏"
    cmds:
      - "{{.METRICS_COMPOSE_CMD}} logs {{.CLI_ARGS}}"

  metrics:status:
    desc: "–°—Ç–∞—Ç—É—Å —Å—Ç–µ–∫–∞ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏"
    cmds:
      - "{{.METRICS_COMPOSE_CMD}} ps -a"
